// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  clerkUserId  String?   @unique // Clerk user ID for syncing
  email        String    @unique
  name         String
  credit       Int
  role         String    @default("PATIENT") // PATIENT or DOCTOR
  firstName    String?
  lastName     String?
  phone        String?
  surgeryType  String?   // Type of surgery patient had
  surgeryDate  DateTime? // Date of surgery
  riskScore    Int       @default(5) // 0-10 risk assessment
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt
  sessions     Session[] @relation("UserSessions")
  dailyTracking DailyTracking[] @relation("UserDailyTracking")
  medicationLogs MedicationLog[] @relation("UserMedicationLogs")
  chatMessages ChatMessage[] @relation("UserChatMessages")
}

model Doctor {
  id           String    @id @default(uuid())
  clerkUserId  String    @unique
  name         String
  specialization String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Patient {
  id           String    @id @default(uuid())
  clerkUserId  String    @unique
  name         String
  surgery      String    // Appendectomy, Knee Replacement, Cesarean Section
  surgeryDate  DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sessions     PatientSession[]
  alerts       Alert[]
}

model ChatMessage {
  id          String   @id @default(uuid())
  patientId   Int
  patient     User     @relation("UserChatMessages", fields: [patientId], references: [id], onDelete: Cascade)
  role        String   // "patient" or "doctor"
  message     String   @db.Text
  audioUrl    String?  // URL to voice recording (for patient) or TTS audio (for doctor)
  createdAt   DateTime @default(now())
  
  @@index([patientId, createdAt])
}

model PatientSession {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  transcript  String   @db.Text
  painScore   Int      // 0-10
  symptoms    String[] // Array of symptoms detected
  emotion     String   // calm, anxious, distressed, etc.
  language    String   // fr or en
  createdAt   DateTime @default(now())
  
  @@index([patientId, createdAt])
}

model Alert {
  id         String   @id @default(uuid())
  patientId  String
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  level      String   // NORMAL, ORANGE, RED
  reason     String   @db.Text
  createdAt  DateTime @default(now())
  
  @@index([patientId, level, createdAt])
}

model DailyTracking {
  id              String   @id @default(uuid())
  patientId       Int
  patient         User     @relation("UserDailyTracking", fields: [patientId], references: [id], onDelete: Cascade)
  painScore       Int      // 0-10
  mobilityScore   Int      // 0-10
  sleepHours      Float    // Hours of sleep
  sleepQuality    Int      // 0-10
  steps           Int?     // Optional step count
  exerciseMinutes Int?     // Optional exercise duration
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  
  @@index([patientId, createdAt])
}

model MedicationLog {
  id             String   @id @default(uuid())
  patientId      Int
  patient        User     @relation("UserMedicationLogs", fields: [patientId], references: [id], onDelete: Cascade)
  medicationId   String   // ID of the medication
  medicationName String
  dosage         String
  status         String   // "taken", "skipped", "missed"
  scheduledTime  String   // Time it was supposed to be taken (e.g., "08:00")
  takenAt        DateTime? // Actual time it was taken (null if skipped/missed)
  createdAt      DateTime @default(now())
  date           DateTime // Date for this log (for grouping by day)
  
  @@index([patientId, date])
  @@index([patientId, createdAt])
}

model Session {
  id             Int      @id @default(autoincrement())
  sessionId      String   @unique
  notes          String
  selectedDocter Json?
  conversation   Json?
  report         Json?
  createdBy      String
  patientId      Int?
  patient        User?    @relation("UserSessions", fields: [patientId], references: [id], onDelete: Cascade)
  createdOn      String
  // Voice check-in data
  transcription  String?  @db.Text
  painScore      Int?     // 0-10
  symptoms       String[] // Array of symptoms
  mobility       String?
  emotion        String?
  language       String?  // en, fr, ar, etc.
  summary        String?  @db.Text
  redFlags       String[] // Array of red flag strings
  createdAt      DateTime @default(now())
  
  @@index([patientId, createdAt])
}
